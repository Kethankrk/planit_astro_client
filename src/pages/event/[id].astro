---
import MainLayout from "@/layout/MainLayout.astro";
import { TicketCard } from "@/components/event/TicketCard";
import { CreateTicketOption } from "@/components/event/CreateTicket";
import EventUserInteractionSection from "@/components/event/EventUserInteractionSection";
import { MapPinCheckInside, Calendar } from "lucide-react";
import { Image } from "astro:assets";
import { EventService } from "@/services/event";
import { TicketService } from "@/services/ticket";
import { CustomError } from "@/lib/api";
import type { EventSelectType } from "@/db/schema/event";
const { id } = Astro.params;
let eventData: EventSelectType;
let tickets = [];
try {
  eventData = await EventService.getInstance().get(Number(id));
  tickets = await TicketService.getInstance().getAll(Number(id));
} catch (error) {
  if (error instanceof CustomError && error.statusCode === 404) {
    return Astro.redirect("/404");
  }
  console.log(error);
  return Astro.redirect("/500");
}
---

<MainLayout>
  <div class="w-full pb-20">
    <div class="flex w-full bg-secondary rounded-lg">
      <Image
        width={50}
        height={50}
        src={eventData.banner}
        class="h-[400px] w-auto mx-auto"
        alt="event banner"
      />
    </div>
    <div class="flex justify-between items-center">
      <h2 class="text-3xl font-bold mt-5">{eventData.title}</h2>
      <EventUserInteractionSection client:only />
    </div>
    <div class="flex gap-10 mt-5">
      <div class="flex gap-1">
        <Calendar className="text-blue-400" />
        <span
          >{eventData.startAt.toLocaleString()} - {
            eventData.endingAt.toLocaleString()
          }</span
        >
      </div>
      <div class="flex gap-1">
        <MapPinCheckInside className="text-blue-400" />
        <span>{eventData.location}</span>
      </div>
    </div>
    <p class="mt-10">
      {eventData.description}
    </p>
    {
      eventData.requirements && (
      <h2 class="text-2xl font-bold mt-20">Requirements</h2>
      <p class="mt-2">
        Lorem, ipsum dolor sit amet consectetur adipisicing elit. Dignissimos, ex!
      </p>
      )
    }
    <div class="flex justify-between items-center mt-20">
      <h2 class="text-2xl font-bold">Tickets</h2>
      <CreateTicketOption client:load eventId={id!} />
    </div>
    {
      !tickets.length && (
        <p class="font-semibold mt-5">No tickets found, Please create one</p>
      )
    }
    <div class="mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
      {
        tickets.map((ticket) => (
          <TicketCard
            title={ticket.title}
            price={ticket.price}
            limit={ticket.limit}
            navLink={`/ticket/${ticket.id}`}
          />
        ))
      }
    </div>
  </div>
</MainLayout>
